<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.6" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.6">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.6" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.6',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="All-trade Jack, loves full-stack">
<meta property="og:type" content="website">
<meta property="og:title" content="CMK">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="CMK">
<meta property="og:description" content="All-trade Jack, loves full-stack">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CMK">
<meta name="twitter:description" content="All-trade Jack, loves full-stack">






  <link rel="canonical" href="http://yoursite.com/page/3/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>CMK</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-116541729-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116541729-1');
</script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CMK</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Let's create something!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
</li>

      

      
    </ul>
  

  
    

    
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
    

  


  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-categories" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/21/Authetication-JWT-vs-Session/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mingkai Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sea.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMK">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/21/Authetication-JWT-vs-Session/" itemprop="url">Authetication: JWT vs Session</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-21T21:59:55-07:00">2018-05-21</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Full-stack/" itemprop="url" rel="index"><span itemprop="name">Full stack</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/21/Authetication-JWT-vs-Session/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments:</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/05/21/Authetication-JWT-vs-Session/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="I-Why-do-we-need-Authetication"><a href="#I-Why-do-we-need-Authetication" class="headerlink" title="I. Why do we need Authetication?"></a>I. Why do we need Authetication?</h2><p><strong>Scenario: bank accout transaction</strong></p>
<blockquote>
<p>Authetication: an approach to know “Alice” from client side is the real “Alice” in the bank database</p>
</blockquote>
<p>The bank web server needs a way to identify its customers’ true identity, knowing ‘Alice’ is the real ‘Alice’ as she claims.</p>
<h2 id="II-session-amp-cookie-authetication"><a href="#II-session-amp-cookie-authetication" class="headerlink" title="II. session&amp;cookie authetication"></a>II. <code>session&amp;cookie</code> authetication</h2><p><strong>1. Solution A</strong>   </p>
<p>An approach is checking her account&amp;password. If matches, she can access Alice’s bank account; Otherwise, no way to Alice’s bank account.</p>
<p><strong>2. Problem of Solution A</strong> </p>
<p>HTTP is stateless. After Alice log into the server, next time when Alice make another request to draw ¥100 from her account (<em>subtract ¥100 from her accout</em>). Now she still needs to prove she is Alice. But asking her accout&amp;password again and again is rediculous!</p>
<p><strong>3. Solution B:<code>session</code> &amp; <code>cookie</code></strong> </p>
<ul>
<li>First time, the Alice log into her account on bank server; </li>
<li>Bank server maintains a session for her, and issues <code>sessionID</code> to her <code>cookie</code>. </li>
<li>Later, each time Alice want to make a transaction, she makes HTTP requests with that <code>sessionID</code>(all HTTP requests carry <code>cookie</code> )</li>
<li>Until a certain period of time, the <code>session</code> for Alice become invalid if no activities from Alice</li>
<li>After a inactive period, if Alice wants to make transaction again, she has to log into system to set up a new <code>session</code> in bank server</li>
<li><code>Server</code>is the safe guard**, preventing evil from accessing sensitive bank account information. Using <code>session</code>and<code>cookie</code>, customers finally don’t have to input their account&amp;password again and again!</li>
</ul>
<p><strong>4. New problem in “distributed” serivce system</strong>   </p>
<ul>
<li><p><strong><code>Distributed</code></strong> means: after Alice log into her account on server#1, next time she might be directed by <code>load balancer</code> to server#2, if at that time server#1 is already serving extremely large amount of people.</p>
</li>
<li><p><strong>New problem is:</strong> <code>session &amp; cookie</code> approach doesn’t work in this case. Server#1 has Alice’s necessary<code>context</code> for following transaction after she logs into it. But server#2 doesn’t even know who she is! So, Alice is asked for her account and password again! Bad user experience!!!</p>
</li>
</ul>
<p><strong>5. Soutions for “distributed” serivce system</strong>   </p>
<blockquote>
<p>【好文】<a href="https://www.cnblogs.com/study-everyday/p/7853145.html" target="_blank" rel="noopener">https://www.cnblogs.com/study-everyday/p/7853145.html</a></p>
</blockquote>
<ul>
<li><strong>version 1: session dupication (多机同步)</strong><ul>
<li>思路：多个web-server之间相互同步session，这样每个web-server之间都包含全部的session</li>
<li>优点：web-server支持的功能，应用程序不需要修改代码</li>
<li>不足：<ul>
<li>session的同步需要数据传输，占内网带宽，有时延</li>
<li>所有web-server都包含所有session数据，数据量受内存限制，无法水平扩展</li>
<li>有更多web-server时要歇菜</li>
</ul>
</li>
</ul>
</li>
<li><strong>version 2: Session Storage at brower (客户端存储法)</strong><ul>
<li>思路：服务端存储所有用户的session，内存占用较大，可以将session存储到浏览器cookie中，每个端只要存储一个用户的数据了</li>
<li>优点：服务端不需要存储</li>
<li>缺点：<ul>
<li>每次http请求都携带session，占外网带宽</li>
<li>数据存储在端上，并在网络传输，存在泄漏、篡改、窃取等安全隐患</li>
<li>session存储的数据大小受cookie限制</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>version 3: Nginx reverse proxy hash: (反向代理hash一致性)</strong></p>
<ul>
<li>思路：反向代理层使用用户ip来做hash，以保证同一个ip的请求落在同一个web-server上</li>
<li><p>优点：</p>
<ul>
<li>只需要改nginx配置，不需要修改应用代码</li>
<li>负载均衡，只要hash属性是均匀的，多台web-server的负载是均衡的</li>
<li>可以支持web-server水平扩展（session同步法是不行的，受内存限制）</li>
</ul>
</li>
<li><p>不足：</p>
<ul>
<li>如果web-server重启，一部分session会丢失，产生业务影响，例如部分用户重新登录</li>
<li>如果web-server水平扩展，rehash后session重新分布，也会有一部分用户路由不到正确的session</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>version 4: Database layer for whole session(后端统一集中存储)</strong></p>
<ul>
<li>思路：将session存储在web-server后端的存储层，数据库或者缓存</li>
<li><p>优点：</p>
<ul>
<li>没有安全隐患</li>
<li>可以水平扩展，数据库/缓存水平切分即可</li>
<li>web-server重启或者扩容都不会有session丢失</li>
</ul>
</li>
<li><p>不足：</p>
<ul>
<li>增加了一次网络调用，并且需要修改应用代码</li>
</ul>
<p>session读取的频率会很高，数据库压力会比较大。如果有session高可用需求，cache可以做高可用，但大部分情况下session可以丢失，一般也不需要考虑高可用。</p>
</li>
</ul>
</li>
<li><p><strong>Summary: for improved <code>session&amp;cookie</code> approach</strong></p>
<p>  对于方案3和方案4，推荐后者：</p>
<ul>
<li>web层、service层无状态是大规模分布式系统设计原则之一，session属于状态，不宜放在web层</li>
<li>让专业的软件做专业的事情，web-server存session？还是让cache去做这样的事情吧。</li>
</ul>
</li>
</ul>
<h2 id="III-JWT-authetication"><a href="#III-JWT-authetication" class="headerlink" title="III. JWT authetication"></a>III. JWT authetication</h2><blockquote>
<p>好文: <a href="https://www.ctolib.com/flylib-fly-auth.html" target="_blank" rel="noopener">https://www.ctolib.com/flylib-fly-auth.html</a></p>
</blockquote>
<blockquote>
<ol>
<li>server不再作为<code>敏感数据库</code>的关卡，为client服务；</li>
<li>brower自己<code>每次</code>都携带<code>authentication token</code>进行request</li>
</ol>
</blockquote>
<p><strong>0.【JWT本质：】</strong> </p>
<ul>
<li><strong>相当于每次browser request，都要求用户输入<code>account &amp; password</code></strong>   </li>
<li><strong>即：第一次用户登陆成功后，server根据其“用户名密码”生成唯一“令牌token”，往后该用户只要带上该token进行访问就可以</strong>   </li>
<li><strong>相同点：<code>session</code>方法类似，<code>cookie</code>中的<code>sessionID</code>也相当于“令牌token”，每次请求都携带上</strong></li>
<li><strong>不同点：</strong><ul>
<li><strong><code>JWT</code>方法的token生成依赖于<code>用户名密码</code>与<code>SHA256</code>，不受server环境影响</strong></li>
<li><strong><code>session</code>方法的<code>sessionID</code>生成依赖于<code>server session context</code>，每个server生成的<code>sessionID</code>不一致，无法适用于distributed system</strong></li>
</ul>
</li>
</ul>
<p><strong>1. Problems with <code>session</code> approach</strong> </p>
<ul>
<li>memcache或者redis的<strong>稳定性</strong>会影响业务系统的可用性</li>
<li><strong>微服务的并发能力</strong>受限于memcache或者redis的并发能力</li>
<li>由此可见，集中的session管理也不是最优的选择。</li>
<li>我们不再关注session本 ，把session的问题抛开，让我们的服务都是无状态的。</li>
<li>于是我们把目光转向WEB TOKEN: JWT（Json web token ）    </li>
</ul>
<p><strong>2. Benefits using JWT</strong></p>
<blockquote>
<p>【好文】<a href="https://www.ctolib.com/topics-113075.html" target="_blank" rel="noopener">https://www.ctolib.com/topics-113075.html</a></p>
</blockquote>
<ul>
<li>解决跨域问题：这种基于Token的访问策略可以克服cookies的跨域问题。</li>
<li>服务端无状态可以横向扩展，Token可完成认证，无需存储Session。</li>
<li>系统解耦，Token携带所有的用户信息，无需绑定一个特定的认证方案，只需要知道加密的方法和密钥就可以进行加密解密，有利于解耦。</li>
<li>防止跨站点脚本攻击，没有cookie技术，无需考虑跨站请求的安全问题。</li>
</ul>
<p><strong>3. Principle of JWT 原理简介</strong></p>
<p>JSON Web Tokens的格式组成，jwt是一段被base64编码过的字符序列，用点号分隔，一共由三部分组成，头部<code>header</code>，消息体<code>playload</code>和签名<code>sign</code></p>
<ul>
<li><p>头部<code>Header</code>是json格式：</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"typ"</span>:<span class="string">"JWT"</span>,            <span class="comment">// 该类型是JWT类型</span></span><br><span class="line">    <span class="string">"alg"</span>:<span class="string">"HS256"</span>,          <span class="comment">// 加密方式声明是HS256</span></span><br><span class="line">    <span class="string">"exp"</span>:<span class="number">1491066992916</span>     <span class="comment">// expire 代表过期时间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>消息体<code>Playload</code>json格式：</p>
<p>  消息体的具体字段可根据业务需要自行定义和添加，只需在解密的时候注意拿字段的key值获取value。</p>
<pre><code class="javascript">{
    <span class="string">"userid"</span>:<span class="string">"123456"</span>,
    <span class="string">"iss"</span>:<span class="string">"companyName"</span> 
}
</code></pre>
</li>
<li><p>签名<code>sign</code>的生成</p>
<ul>
<li>签名的生成是把header和playload分别使用base64url编码,接着用’.‘把两个编码后的字符串连接起来</li>
<li>再把这拼接起来的字符串配合密钥进行HMAC SHA-256算法加密</li>
<li>然后再次使用base64url编码，这就拿到了签名sign. </li>
<li>最后把header和playload和sign用’.‘ 连接起来就生成了整个JWT。</li>
</ul>
</li>
</ul>
<p><strong>4. Principle of JWT Checking 校验简介</strong></p>
<blockquote>
<p>JWT不能保护数据，只能验证数据是否是原始数据，是否被篡改过</p>
</blockquote>
<p>JWT是由<code>header.playload.sign</code>连接组成，只有sign是用密钥加密的，而所有的信息都在header和playload中可以直接获取，sign的作用只是校验header和playload的信息是否被篡改过</p>
<ol>
<li><p>加密：比如要加密验证的是userid字段：</p>
<ul>
<li>首先按前面的格式组装json消息头header和消息体playload，按header.playload组成字符串；</li>
<li>再根据密钥和HS256加密header.playload得到sign签名；</li>
<li>最后得到jwtToken为header.playload.sign，在http请求中的url带上参数想后端服务请求认证</li>
</ul>
</li>
<li><p>解密：后端服务校验jwtToken是否有权访问接口服务，进行解密认证，如校验访问者的userid：</p>
<ul>
<li>用将字符串按<code>.</code>切分三段字符串，分别得到header和playload和sign。</li>
<li>然后将header.playload拼装用密钥和SHA-256算法进行加密然后得到新的字符串和sign进行比对，</li>
<li>如果一样就代表数据没有被篡改，然后从头部取出exp对存活期进行判断</li>
<li>如果超过了存活期就返回空字符串，如果在存活期内返回userid的值</li>
</ul>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-categories" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/17/2-egg-Puzzle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mingkai Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sea.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMK">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/17/2-egg-Puzzle/" itemprop="url">The Joy of Egg-Dropping(2-egg Puzzle)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-17T22:03:40-07:00">2018-05-17</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Algorithm/" itemprop="url" rel="index"><span itemprop="name">Algorithm</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/17/2-egg-Puzzle/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments:</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/05/17/2-egg-Puzzle/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="I-Problem-statement"><a href="#I-Problem-statement" class="headerlink" title="I. Problem statement"></a>I. Problem statement</h3><p><strong>1. Easy version</strong></p>
<blockquote>
<p>Given infinite number of same eggs, try with minimun trials to find out  the highest floor where tossing the egg won’t result in egg crash. The building has 200 floors.</p>
</blockquote>
<ul>
<li>变量：N=200</li>
<li>目标：试验次数最小</li>
<li>约束：none</li>
</ul>
<p><strong>2. Hard version</strong></p>
<blockquote>
<p>Only 2 eggs were given, try with minimun trials to find the highest floor where tossing the egg won’t result in egg crash. The building has 200 floors. (The egg can be reused as long as it is intact)</p>
</blockquote>
<ul>
<li>变量：F=200, E=2</li>
<li>目标：试验次数最小</li>
<li>约束：</li>
</ul>
<h3 id="II-Solution-for-easy-version"><a href="#II-Solution-for-easy-version" class="headerlink" title="II. Solution for easy version"></a>II. Solution for easy version</h3><p>Since the number of eggs we can use is unlimited, we can use the <strong>fastest approach in the universe</strong> to find the unknown target in a list: <code>binary search</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- left direction: break </span><br><span class="line">- right direction:intact</span><br><span class="line"></span><br><span class="line">0          100        200</span><br><span class="line">         /     \</span><br><span class="line">        50      150</span><br><span class="line">      /   \    /   \</span><br><span class="line">     25   75  125  175</span><br><span class="line">    / \  </span><br><span class="line">  ...   </span><br><span class="line"></span><br><span class="line">Toss an egg on floor 100:</span><br><span class="line">1. if egg break, toss another on floor 50;</span><br><span class="line">    1.1 if egg break, toss another on floor 25;</span><br><span class="line">        1.1.1 ...</span><br><span class="line">        1.1.2 ...</span><br><span class="line">    1.2 if doesn&apos;t break, toss another on floor 75;</span><br><span class="line">        1.2.1 ...</span><br><span class="line">        1.2.2 ...</span><br><span class="line">2. if doesn&apos;t break, toss another on floor 150;</span><br><span class="line">    2.1 if egg break, toss another on floor 125;</span><br><span class="line">        2.1.1 ...</span><br><span class="line">        2.1.2 ...</span><br><span class="line">    2.2 if doesn&apos;t break, toss another on floor 175;</span><br><span class="line">        2.2.1 ...</span><br><span class="line">        2.2.2 ...</span><br></pre></td></tr></table></figure>
<h3 id="III-Solution-for-hard-version"><a href="#III-Solution-for-hard-version" class="headerlink" title="III. Solution for hard version"></a>III. Solution for hard version</h3><p>Since it is not so intuitive at first glance, we will take a few trials to get a deeper understanding of this problem.</p>
<p>General idea:   </p>
<blockquote>
<p>egg-1 used to narrow down possible range<br>egg-2 used to sequentially find the target floor</p>
</blockquote>
<ol>
<li><p><strong>[egg-1 with step=10]</strong> egg-1 tossed on floor 20,40,60,80,100,120,… with a step=20</p>
<ul>
<li>worst-case: 29 trials<ul>
<li>egg-1 tossed on 200 and break: 10 trials</li>
<li>egg-2 tossed on 199 (from 181), break: 19 trials</li>
</ul>
</li>
<li>best-case: 2 trials<ul>
<li>egg-1 tossed on 20 and break: 1 trials</li>
<li>egg-2 tossed on 1: 1 trials</li>
</ul>
</li>
<li>for this method, what is the min trials can we say?<ul>
<li>29 trials(the worst case), no worse than it</li>
<li>we cannot guarantee it is the best case</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>[edge case: BS]</strong> egg-1 tossed on floor 100, 200</p>
<ul>
<li>worst-case: 201 trials<ul>
<li>egg-1 tossed on 200 and break: 2 trials</li>
<li>egg-2 tossed on 199 (from 101), break: 199 trials</li>
</ul>
</li>
<li>best-case: 2 trials<ul>
<li>egg-1 tossed on 100 and break: 1 trials</li>
<li>egg-2 tossed on 1: 1 trials</li>
</ul>
</li>
<li>for this method, what is the min trials can we say?<ul>
<li>201 trials(the worst case), no worse than it</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>[Solution 1]</strong> </p>
<ul>
<li><a href="https://www.zhihu.com/question/19690210/answer/22937826" target="_blank" rel="noopener">https://www.zhihu.com/question/19690210/answer/22937826</a></li>
<li>the ‘step’ affect min-trial</li>
<li>we want control ‘step’ to make the trials of worst case and best case as close as possible; This way it will divvy up the trial between worst and best cases</li>
<li>Goal: worst case trials = best case trials</li>
<li>egg-1 tossed on floor x, 2x-1, 3x-2, .. 1</li>
<li>蛋一第一次扔在X层，第二次扔在比原来高 X-1层，… 高2， 高1，使得X+(X-1)+…+2+1=200</li>
<li>最坏情况(=最好情况)总的次数就是：<ul>
<li>如果在第X层就碎，那么蛋二最坏情况要扔X-1，所以总数是 1+X-1=X</li>
<li>如果在X+(X-1)碎，那么蛋二最坏情况要扔 X-2，所以2+X-2=X</li>
</ul>
</li>
<li><p>x = 20</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|_|__</span><br><span class="line">|_|     x-2</span><br><span class="line">|_|__   </span><br><span class="line">|_|     x-1</span><br><span class="line">|_|___ </span><br><span class="line">|_|     x</span><br><span class="line">|_|</span><br><span class="line">|_|___</span><br></pre></td></tr></table></figure>
</li>
<li><p>假设蛋一第一次扔在X层，第二次扔在比原来高 X-1层，… 高2， 高1，使得X+(X-1)+…+2+1=100，那么最坏情况总的次数就是：如果在第X层就碎，那么蛋二最坏情况要扔X-1，所以总数是 1+X-1=X如果在X+(X-1)碎，那么蛋二最坏情况要扔 X-2，所以2+X-2=X</p>
</li>
</ul>
</li>
</ol>
<ol start="4">
<li><p><strong>[Solution 2]</strong> </p>
<ul>
<li><p>链接：<a href="https://www.zhihu.com/question/19690210/answer/125713075" target="_blank" rel="noopener">https://www.zhihu.com/question/19690210/answer/125713075</a></p>
</li>
<li><p>子问题F[i, j]: H的可行范围为[0, i]，手上还有j个鸡蛋的时候，最坏情况下的最小试验次数是多少。我们的目标函数就是F[N, K]。</p>
</li>
<li>这个能够设立是基于这样一种想法，如果H的可能范围目前是[L, R]，那么其状态与[0, R-L]是完全一致的，所以我们仅仅记录有可行范围的宽度就可以了。</li>
<li><code>F[i, j]=min{max{F[k-1, j-1], F[i-k, j]}}+1，</code><ul>
<li>其中1&lt;=k&lt;=i。k表示这一次实验是从k楼把鸡蛋扔下去，扔下去有两种结果。</li>
<li>一种是鸡蛋碎了，那么剩余的鸡蛋个数是j-1，H的可行范围变为[0, k-1]，那么需要的最少实验次数为F[k-1, j-1]。</li>
<li>另一种是鸡蛋没碎，那么剩余的鸡蛋个数是j，H的可行范围是[k, i]，那么需要的最少实验次数是F[k-i, j]。</li>
</ul>
</li>
<li>由于题目所求的是最坏情况下的最优策略，所以对每种k情况内取max，再对所有k取min。</li>
<li>边界条件为<code>F[0, j]=0，F[i, 1]=i</code>。</li>
<li>时间复杂度为O(NK^2)。</li>
</ul>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-categories" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/15/React-Router-v4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mingkai Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sea.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMK">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/15/React-Router-v4/" itemprop="url">React Router v4</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-15T21:21:05-07:00">2018-05-15</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Full-stack/" itemprop="url" rel="index"><span itemprop="name">Full stack</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/15/React-Router-v4/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments:</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/05/15/React-Router-v4/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="I-Three-types-of-Components："><a href="#I-Three-types-of-Components：" class="headerlink" title="I. Three types of Components："></a>I. Three types of Components：</h3><p><strong>1. router components</strong></p>
<blockquote>
<p>create a history object, 提供“前进”、“后退”</p>
</blockquote>
<ul>
<li><strong><code>&lt;BrowserRouter&gt;</code></strong>: for server that responds to requests</li>
<li><strong><code>&lt;HashRouter&gt;</code></strong>: for a static file server.</li>
</ul>
<p><strong>2. route matching components</strong></p>
<blockquote>
<p>comparing a <route>‘s path prop with the current location’s pathname<br>只要路由匹配，Route所在位置就会render相应的Component</route></p>
</blockquote>
<ul>
<li><p><strong><code>&lt;Route&gt;</code> ：包容性路由</strong></p>
<ul>
<li>3个props： <ul>
<li>path：匹配路径</li>
<li>component：对应的组件</li>
<li>render：没有可用组件时，直接render<ul>
<li>1个state：</li>
</ul>
</li>
<li>match</li>
<li>match包含4个field：<code>isExact</code>,<code>params</code>,<code>path</code>,<code>url</code><ul>
<li>1个context：</li>
</ul>
</li>
</ul>
</li>
<li>router obj</li>
<li>router 包含 <code>history</code>,<code>routes</code></li>
</ul>
</li>
<li><p><strong><code>&lt;Switch&gt;</code>：排他性路由</strong></p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;Switch&gt;</span><br><span class="line">    &lt;Route exact path=<span class="string">'/'</span> component=	&#123;Home&#125;/&gt;</span><br><span class="line">    &lt;Route path=<span class="string">'/about'</span> component=&#123;About&#125;/&gt;</span><br><span class="line">    &lt;Route path=<span class="string">'/contact'</span> component=&#123;Contact&#125;/&gt;</span><br><span class="line">    &lt;Route component=&#123;NoMatch&#125;/&gt;</span><br><span class="line">&lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ when none of the above match, &lt;NoMatch&gt; will be rendered</span></span><br></pre></td></tr></table></figure>
<ul>
<li>How ？<br>iterate over all of its children <route> elements and only render the first one that matches the current location.</route></li>
<li>Props: <code>component</code>, <code>render</code>, and <code>children</code></li>
</ul>
</li>
</ul>
<p><strong>3. navigation components</strong></p>
<ul>
<li><strong><code>&lt;Link&gt;</code></strong></li>
<li><strong><code>&lt;NavLink&gt;</code></strong> :a special type of <link> that can style itself as “active” when its ‘to’ prop matches the current location.</li>
<li><strong><code>&lt;Redirect&gt;</code></strong>: navigate using its ‘to’ prop<ul>
<li>注意：不是 “函数”，而是“组件”，需要放在render中return</li>
<li>没有路由解析时候，可以直接使用redirect，重定向到默认页面</li>
</ul>
</li>
</ul>
<h3 id="II-3种方式renders-Component"><a href="#II-3种方式renders-Component" class="headerlink" title="II. 3种方式renders Component"></a>II. 3种方式renders Component</h3><ul>
<li><code>&lt;Route component&gt;</code></li>
<li><code>&lt;Route render&gt;</code></li>
<li><code>&lt;Route children&gt;</code></li>
</ul>
<h3 id="III-Route在render-component同时，传入3个量，作为component的props（不论3中方式的哪一种）"><a href="#III-Route在render-component同时，传入3个量，作为component的props（不论3中方式的哪一种）" class="headerlink" title="III. Route在render component同时，传入3个量，作为component的props（不论3中方式的哪一种）"></a>III. Route在render component同时，传入3个量，作为component的props（不论3中方式的哪一种）</h3><ul>
<li>match</li>
<li>history</li>
<li>location</li>
</ul>
<p>比如render:func( )方式render conponent</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eg1: </span></span><br><span class="line">  &lt;Route path=<span class="string">"/home"</span> render=&#123;() =&gt; <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>&#125;/&gt;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// eg2: wrapping/composing</span></span><br><span class="line">  <span class="keyword">const</span> FadingRoute = <span class="function">(<span class="params">&#123; component: Component, ...rest &#125;</span>) =&gt;</span> (</span><br><span class="line">    &lt;Route &#123;...rest&#125; render=&#123;props =&gt; (</span><br><span class="line">      &lt;FadeIn&gt;</span><br><span class="line">        &lt;Component &#123;...props&#125;/&gt;</span><br><span class="line">      &lt;<span class="regexp">/FadeIn&gt;</span></span><br><span class="line"><span class="regexp">    )&#125;/</span>&gt;</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">  &lt;FadingRoute path=<span class="string">"/cool"</span> component=&#123;Something&#125;/&gt;<span class="string">"</span></span><br><span class="line"><span class="string">  - render props: path、children／render／component、</span></span><br><span class="line"><span class="string">  - render state：match</span></span><br><span class="line"><span class="string">  - component props(route所render): history、location、match</span></span><br><span class="line"><span class="string">    "</span>不论是哪种方式render，都会拿到这三个props<span class="string">"</span></span><br><span class="line"><span class="string">  - 因此，eg2中render:func方式，直接将props作为function component的参数传入</span></span><br><span class="line"><span class="string">    "</span>render=&#123; props =&gt; (</span><br><span class="line">        &lt;FadeIn&gt;</span><br><span class="line">          &lt;Component &#123;...props&#125;/&gt;</span><br><span class="line">        &lt;<span class="regexp">/FadeIn&gt;</span></span><br><span class="line"><span class="regexp">      )&#125;"</span></span><br></pre></td></tr></table></figure>
<h3 id="IV-Route-vs-Component如何关联"><a href="#IV-Route-vs-Component如何关联" class="headerlink" title="IV. Route vs Component如何关联"></a>IV. Route vs Component如何关联</h3><ul>
<li>Router 将路径 match上之后，会调用相应的 Route， 由Route 将相关的参数：match、location、history等传入到 Component中</li>
<li>Route 的 state: match、location 传入到 Component的 props: match、location</li>
<li>The Route will render <dashboard {...props}=""> , where props are some router specific things that look like { match, location, history }. </dashboard></li>
<li>If the user is not at /dashboard then the Route will render null. That’s pretty much all there is to it.</li>
</ul>
<h3 id="V-match-url-vs-match-path"><a href="#V-match-url-vs-match-path" class="headerlink" title="V. match.url vs match.path"></a>V. <code>match.url</code> vs <code>match.path</code></h3><blockquote>
<p>A match object contains information about how a <route path=""> matched the URL.</route></p>
</blockquote>
<ul>
<li>match：是 <code>route</code>的<code>state</code>；是<code>component</code>的<code>props</code></li>
<li>Eg: consider the route <code>/users/:userId</code><ul>
<li><code>match.path</code> - (string) 用于匹配路径模式。用于构建嵌套的 <route>; <code>match.path</code> would be <code>/users/:userId</code></route></li>
<li><code>match.url</code> - (string) URL 匹配的部分。 用于构建嵌套的 <link>; <code>match.url</code> would have the :userId value filled in, e.g. “users/5”.”</li>
</ul>
</li>
</ul>
<h3 id="VI-match-params-表示-url-匹配上的变量值"><a href="#VI-match-params-表示-url-匹配上的变量值" class="headerlink" title="VI. match.params 表示 url 匹配上的变量值"></a>VI. <code>match.params</code> 表示 url 匹配上的变量值</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route path=<span class="string">"/:id"</span> component=&#123;Child&#125; /&gt;</span><br><span class="line"></span><br><span class="line">&#123;match.params.id&#125;</span><br></pre></td></tr></table></figure>
<p>URL 后半部分由变量 id 兜住，如果进来的url为<code>/abc</code>，那么 <code>match.params.id = abc</code></p>
<h3 id="VII-Eg-Custom-Link"><a href="#VII-Eg-Custom-Link" class="headerlink" title="VII. Eg: Custom Link"></a>VII. Eg: Custom Link</h3><blockquote>
<p>Route实际上是 Component 的买办，为Component办事！<br>Route放在哪个位置，那里就有可能render出它携带的component(只要url match)</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route path=<span class="string">"/abc"</span> component=&#123;Child_1&#125; /&gt;</span><br><span class="line">&lt;Route path=<span class="string">"/abc"</span> component=&#123;Child_2&#125; /&gt;</span><br><span class="line">&lt;Route path=<span class="string">"/abc"</span> component=&#123;Child_3&#125; /&gt;</span><br></pre></td></tr></table></figure>
<h3 id="VIII-lt-Prompt-gt-：防止中途跳转"><a href="#VIII-lt-Prompt-gt-：防止中途跳转" class="headerlink" title="VIII. &lt;Prompt&gt;：防止中途跳转"></a>VIII. <code>&lt;Prompt&gt;</code>：防止中途跳转</h3><blockquote>
<p>适用情况：用户在填表过程中，点击了“后退”或“跳转链接”，需弹窗询问<br><code>&lt;Prompt&gt;</code>是保留tag，跟<code>&lt;Link&gt;</code>一样</p>
</blockquote>
<ul>
<li>创建一个wrapper，包含<code>&lt;form&gt;</code>, <code>&lt;Prompt&gt;</code></li>
<li>wrapper中设置<code>state.inMiddle</code>，来决定是否render<code>&lt;Prompt&gt;</code></li>
<li>改变<code>state.inMiddle</code>的根源：<code>form</code>中的<code>input</code>输入框；<ul>
<li>只要有任何输入值，就将<code>state.inMiddle</code>置为<code>true</code></li>
<li>提交form后，将form reset()之后，需要将<code>state.inMiddle</code>置为<code>false</code></li>
</ul>
</li>
<li><code>Prompt</code>的props:<ul>
<li><code>when</code>：检查<code>state.inMiddle</code></li>
<li><code>message</code>: 决定弹窗的显示信息</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Form</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    isBlocking: <span class="literal">false</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; isBlocking &#125; = <span class="keyword">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;form</span><br><span class="line">        onSubmit=&#123;event =&gt; &#123;</span><br><span class="line">          event.preventDefault();</span><br><span class="line">          event.target.reset();</span><br><span class="line">          <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            isBlocking: <span class="literal">false</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;&#125;</span><br><span class="line">        &gt;</span><br><span class="line">        </span><br><span class="line">        &lt;Prompt</span><br><span class="line">          when=&#123;isBlocking&#125;</span><br><span class="line">          message=&#123;location =&gt;</span><br><span class="line">            <span class="string">`Are you sure you want to go to <span class="subst">$&#123;location.pathname&#125;</span>`</span></span><br><span class="line">          &#125;</span><br><span class="line">        /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;input</span><br><span class="line">        placeholder=<span class="string">"type something"</span></span><br><span class="line">        onChange=&#123;event =&gt; &#123;</span><br><span class="line">          <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            isBlocking: event.target.value.length &gt; <span class="number">0</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        &lt;button&gt;Submit&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      &lt;/</span>form&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li>Official API: <a href="https://reacttraining.com/react-router/web/guides/philosophy" target="_blank" rel="noopener">https://reacttraining.com/react-router/web/guides/philosophy</a></li>
<li>中文版API：<a href="https://www.jianshu.com/p/e3adc9b5f75c" target="_blank" rel="noopener">https://www.jianshu.com/p/e3adc9b5f75c</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-categories" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/14/Node-MySQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mingkai Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sea.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMK">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/14/Node-MySQL/" itemprop="url">Node+MySQL</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-14T21:30:13-07:00">2018-05-14</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Full-stack/" itemprop="url" rel="index"><span itemprop="name">Full stack</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/14/Node-MySQL/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments:</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/05/14/Node-MySQL/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h3><p>This is a Node.js module, install:<br><code>npm install mysql --save</code></p>
<h3 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h3><p>Before connecting to databases, make sure MySQL database is turned on.</p>
<p>【注意】：</p>
<ul>
<li>先执行 <code>connect()</code>,让connection object与数据库建立连接。</li>
<li>然后，在对该connection执行<code>.query(MySQL_Command, callback_func)</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mysql      = <span class="built_in">require</span>(<span class="string">'mysql'</span>);</span><br><span class="line"><span class="keyword">var</span> connection = mysql.createConnection(&#123;</span><br><span class="line">  host     : <span class="string">'example.org'</span>,</span><br><span class="line">  user     : <span class="string">'bob'</span>,</span><br><span class="line">  password : <span class="string">'secret'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">connection.query(<span class="string">'SELECT 1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, results, fields</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">  <span class="comment">// connected!</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Disconnect"><a href="#Disconnect" class="headerlink" title="Disconnect"></a>Disconnect</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">connection.end(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Callback function</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Escaping-query-values"><a href="#Escaping-query-values" class="headerlink" title="Escaping query values"></a>Escaping query values</h3><p>Three ways to avoid <strong>SQL injection</strong></p>
<ul>
<li>mysql.escape()</li>
<li>connection.escape() </li>
<li>pool.escape()</li>
<li><code>?</code>placeholder</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1 -connection.escape()</span></span><br><span class="line"><span class="keyword">var</span> userId = <span class="string">'some user provided value'</span>;</span><br><span class="line"><span class="keyword">var</span> sql    = <span class="string">'SELECT * FROM users WHERE id = '</span> + connection.escape(userId);</span><br><span class="line">connection.query(sql, <span class="function"><span class="keyword">function</span> (<span class="params">error, results, fields</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 - ? placeholder</span></span><br><span class="line"><span class="keyword">var</span> adr = <span class="string">'Mountain 21'</span>;</span><br><span class="line"><span class="keyword">var</span> sql = <span class="string">'SELECT * FROM customers WHERE address = ?'</span>;</span><br><span class="line">con.query(sql, [adr], <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Creating-a-Database"><a href="#Creating-a-Database" class="headerlink" title="Creating a Database"></a>Creating a Database</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">"CREATE DATABASE mydb"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Database created"</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Creating-a-Table"><a href="#Creating-a-Table" class="headerlink" title="Creating a Table"></a>Creating a Table</h3><p>Two ways:</p>
<ul>
<li>create database and table simultenously</li>
<li>first create database, and connect it; then create table with the connection</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// approach 1</span></span><br><span class="line"></span><br><span class="line">connection.query(<span class="string">"CREATE DATABASE db"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, rows, fields</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">connection.query(<span class="string">"USE db"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, rows, fields</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">connection.query(<span class="string">"CREATE TABLE tb(id INT, name VARCHAR(50))"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, rows, fields</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------</span></span><br><span class="line"><span class="comment">// approach 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> con = mysql.createConnection(&#123;</span><br><span class="line">  host: <span class="string">"localhost"</span>,</span><br><span class="line">  user: <span class="string">"yourusername"</span>,</span><br><span class="line">  password: <span class="string">"yourpassword"</span>,</span><br><span class="line">  database: <span class="string">"mydb"</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">con.connect(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sql = <span class="string">"CREATE TABLE customers (name VARCHAR(255), address VARCHAR(255))"</span>;</span><br><span class="line"></span><br><span class="line">con.query(sql, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Table created"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Selecting-From-a-Table"><a href="#Selecting-From-a-Table" class="headerlink" title="Selecting From a Table"></a>Selecting From a Table</h3><p>To select data from a table in MySQL, use the <code>SELECT</code> statement.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sql = <span class="string">"SELECT * FROM customers WHERE address = 'Park Lane 38'"</span>;</span><br><span class="line"></span><br><span class="line">con.query(sql, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>Wildcard Characters</strong><code>%</code>: represent zero, one or multiple characters:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sql = <span class="string">"SELECT * FROM customers WHERE address LIKE 'S%'"</span></span><br></pre></td></tr></table></figure>
<h3 id="Insert-Into-Table"><a href="#Insert-Into-Table" class="headerlink" title="Insert Into Table"></a>Insert Into Table</h3><p>To fill a table in MySQL, use the <code>INSERT INTO</code> statement.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sql = <span class="string">"INSERT INTO customers (name, address) VALUES ('Company Inc', 'Highway 37')"</span>;</span><br><span class="line"></span><br><span class="line">con.query(sql, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"1 record inserted"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Update-Table"><a href="#Update-Table" class="headerlink" title="Update Table"></a>Update Table</h3><p>You can update existing records in a table by using the <code>UPDATE</code> statement:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sql = <span class="string">"UPDATE customers SET address = 'Canyon 123' WHERE address = 'Valley 345'"</span>;</span><br><span class="line"></span><br><span class="line">  con.query(sql, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(result.affectedRows + <span class="string">" record(s) updated"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Sort-the-Result"><a href="#Sort-the-Result" class="headerlink" title="Sort the Result"></a>Sort the Result</h3><p>Use the <code>ORDER BY</code> statement to sort the result in ascending or descending order.</p>
<p>The <code>ORDER BY</code> keyword sorts the result ascending by default. To sort the result in descending order, use the <code>DESC</code> keyword.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sql = <span class="string">"SELECT * FROM customers ORDER BY name DESC"</span>;</span><br><span class="line"></span><br><span class="line">con.query(sql, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Delete-Record"><a href="#Delete-Record" class="headerlink" title="Delete Record"></a>Delete Record</h3><p>You can delete records from an existing table by using the <code>DELETE FROM</code> statement:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sql = <span class="string">"DELETE FROM customers WHERE address = 'Mountain 21'"</span>;</span><br><span class="line"></span><br><span class="line">con.query(sql, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Number of records deleted: "</span> + result.affectedRows);</span><br></pre></td></tr></table></figure>
<h3 id="Limit-the-Result"><a href="#Limit-the-Result" class="headerlink" title="Limit the Result"></a>Limit the Result</h3><p>You can limit the number of records returned from the query, by using the <code>LIMIT</code> statement:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sql = <span class="string">"SELECT * FROM customers LIMIT 5"</span>;</span><br><span class="line"></span><br><span class="line">con.query(sql, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"><span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Join-Two-or-More-Tables"><a href="#Join-Two-or-More-Tables" class="headerlink" title="Join Two or More Tables"></a>Join Two or More Tables</h3><p>Combine rows from two or more tables, based on a related column between them, by using a <code>JOIN</code> statement.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//users</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123; id: 1, name: &apos;John&apos;, favorite_product: 154&#125;,</span><br><span class="line">  &#123; id: 2, name: &apos;Peter&apos;, favorite_product: 154&#125;,</span><br><span class="line">  &#123; id: 3, name: &apos;Amy&apos;, favorite_product: 155&#125;,</span><br><span class="line">  &#123; id: 4, name: &apos;Hannah&apos;, favorite_product:&#125;,</span><br><span class="line">  &#123; id: 5, name: &apos;Michael&apos;, favorite_product:&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// products</span><br><span class="line">[</span><br><span class="line">  &#123; id: 154, name: &apos;Chocolate Heaven&apos; &#125;,</span><br><span class="line">  &#123; id: 155, name: &apos;Tasty Lemons&apos; &#125;,</span><br><span class="line">  &#123; id: 156, name: &apos;Vanilla Dreams&apos; &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><strong>1. Inner join</strong></p>
<p>These two tables can be combined by using users’ favorite_product field and products’ id field.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sql = <span class="string">"SELECT users.name AS user, products.name AS favorite FROM users JOIN products ON users.favorite_product = products.id"</span>;</span><br><span class="line">    </span><br><span class="line">con.query(sql, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"><span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>2. Left Join</strong><br>If you want to return all users, no matter if they have a favorite product or not, use the LEFT JOIN statement:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT users.name AS user,</span><br><span class="line">products.name AS favorite</span><br><span class="line">FROM users</span><br><span class="line">LEFT JOIN products ON users.favorite_product = products.id</span><br></pre></td></tr></table></figure>
<p><strong>3. Right Join</strong><br>If you want to return <strong>all products</strong>, and the users who have them as their favorite, even if no user have them as their favorite, use the RIGHT JOIN statement:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT users.name AS user,</span><br><span class="line">products.name AS favorite</span><br><span class="line">FROM users</span><br><span class="line">RIGHT JOIN products ON users.favorite_product = products.id</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-categories" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/23/React-Expense-Tracking-app/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mingkai Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sea.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMK">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/23/React-Expense-Tracking-app/" itemprop="url">React: Expense Tracking app</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-23T11:47:10-07:00">2018-04-23</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Portfolios/" itemprop="url" rel="index"><span itemprop="name">Portfolios</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/23/React-Expense-Tracking-app/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments:</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/04/23/React-Expense-Tracking-app/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="I-About"><a href="#I-About" class="headerlink" title="I. About"></a>I. About</h2><ul>
<li>An expense tracking application proving CRUD using React.</li>
<li>Github: <ul>
<li><a href="https://github.com/caomingkai/Expense-Tracking.git" target="_blank" rel="noopener">https://github.com/caomingkai/Expense-Tracking.git</a></li>
</ul>
</li>
<li><p><strong>Chart1: Create</strong></p>
  <img src="/2018/04/23/React-Expense-Tracking-app/create.gif">
</li>
<li><p>**Chart2: Update</p>
  <img src="/2018/04/23/React-Expense-Tracking-app/update.gif">
</li>
<li><p><strong>Chart3: Delete</strong></p>
  <img src="/2018/04/23/React-Expense-Tracking-app/delete.gif">
</li>
</ul>
<h2 id="II-Structure"><a href="#II-Structure" class="headerlink" title="II. Structure"></a>II. Structure</h2><h3 id="1-Components-Structure"><a href="#1-Components-Structure" class="headerlink" title="1. Components Structure"></a>1. Components Structure</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">App</span><br><span class="line"> |___ Summary</span><br><span class="line"> |___ Form _ _ _ _ RecordsAPI</span><br><span class="line"> |                    |</span><br><span class="line"> |___ Table           |</span><br><span class="line">         |_______ TableRow</span><br><span class="line">                      |____ TableDisplay</span><br><span class="line">                      |____ TableEdit</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>App Component:</strong> is the data hub<ul>
<li>state: <code>records</code> for entries in Table component</li>
<li>state: <code>isLoaded</code> show loading info, before showing Table</li>
<li>state: <code>error</code> </li>
<li>method: <code>componentDidMount()</code> get data from database</li>
<li>method: <code>addRecord()</code> passed to Form</li>
<li>method: <code>deleteRecord()</code> passed to Table and TableRow</li>
<li>method: <code>updateRecord()</code> passed to Table and TableRow</li>
<li>method: <code>credits()</code> passed to Summary</li>
<li>method: <code>debits()</code> passed to Summary</li>
<li>method: <code>balance()</code> passed to Summary</li>
</ul>
</li>
<li><strong>Summary Component:</strong> displays negative/ positive summation for the <code>records</code></li>
<li><strong>Form Component:</strong> add <code>record</code> into <code>records</code>, updating Table</li>
<li><strong>Table Component:</strong> just pass <code>records</code> to <strong>TableRow</strong></li>
<li><strong>TableRow Component:</strong> display each <code>record</code> in <code>records</code></li>
<li><strong>RecordsAPI:</strong> utility providing interface to make RESTful API call</li>
</ul>
<h3 id="2-File-Structure"><a href="#2-File-Structure" class="headerlink" title="2. File Structure"></a>2. File Structure</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">|__node_modules</span><br><span class="line">|</span><br><span class="line">|__public  </span><br><span class="line">|    |___ index.html</span><br><span class="line">|</span><br><span class="line">|__ src</span><br><span class="line">     |___ utils: RecordsAPI.js</span><br><span class="line">     |</span><br><span class="line">     |___ components:</span><br><span class="line">              |___ App.js</span><br><span class="line">              |___ Form.js</span><br><span class="line">              |___ Summary.js</span><br><span class="line">              |___ Table.js</span><br><span class="line">              |___ TableRow.js</span><br></pre></td></tr></table></figure>
<h2 id="III-Ajax-request"><a href="#III-Ajax-request" class="headerlink" title="III. Ajax request"></a>III. Ajax request</h2><h3 id="Several-Ways"><a href="#Several-Ways" class="headerlink" title="Several Ways:"></a>Several Ways:</h3><ol>
<li>Ajax Libraries<ul>
<li>Axios<ul>
<li>axios.get(url[, config])</li>
<li>axios.delete(url[, config])</li>
<li>axios.head(url[, config])</li>
<li>axios.options(url[, config])</li>
<li>axios.post(url[, data[, config]])</li>
<li>axios.put(url[, data[, config]])</li>
</ul>
</li>
<li>jQuery AJAX</li>
</ul>
</li>
<li><p>Browser built-in <code>window.fetch</code></p>
<p> No need to prepend “window” before <code>fetch()</code>: default obj</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">## No need to prepend "window" before fetch, this is the default obj</span><br><span class="line"></span><br><span class="line">  fetch(<span class="string">'http://example.com/movies.json'</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> response.json();</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">myJson</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(myJson);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="When-and-where-to-initiate-Ajax-call"><a href="#When-and-where-to-initiate-Ajax-call" class="headerlink" title="When and where to initiate Ajax call?"></a>When and where to initiate Ajax call?</h3><p>Do it in <code>componentDidMount</code> lifecycle method. So you can use setState to update your component when the data is retrieved.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line">  fetch(<span class="string">"https://api.example.com/items"</span>)</span><br><span class="line">    .then(<span class="function"><span class="params">res</span> =&gt;</span> res.json())</span><br><span class="line">    .then(</span><br><span class="line">      (result) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">          isLoaded: <span class="literal">true</span>,</span><br><span class="line">          items: result.items</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// Note: it's important to handle errors here</span></span><br><span class="line">      <span class="comment">// instead of a catch() block so that we don't swallow</span></span><br><span class="line">      <span class="comment">// exceptions from actual bugs in components.</span></span><br><span class="line">      (error) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">          isLoaded: <span class="literal">true</span>,</span><br><span class="line">          error</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="IV-Concept"><a href="#IV-Concept" class="headerlink" title="IV. Concept"></a>IV. Concept</h2><h3 id="1-组件数据流-Model-gt-View"><a href="#1-组件数据流-Model-gt-View" class="headerlink" title="1. 组件数据流: Model -&gt; View"></a>1. 组件数据流: Model -&gt; View</h3><ul>
<li><p>父组件M -&gt; 子组件V</p>
<ul>
<li>父组件prop 之间传给 子组件 prop</li>
</ul>
</li>
<li><p>子组件M -&gt; 父组件V</p>
<ul>
<li>回调函数<ul>
<li>父组件向子组件传递回调函数</li>
<li>JS中，function是一等公民，因此传入的值会作为自身field保存起来；与C／Java不同。</li>
</ul>
</li>
</ul>
</li>
<li>sibling 组件间传值 M-&gt;V<ul>
<li>必须依靠二者共同父组件来传递<ul>
<li>但等组件之间的关系越来越复杂时候，这种依靠父组件作为中间人传值方式 would be a mess！</li>
<li>Redux comes into picture</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-双向绑定-Model-View"><a href="#2-双向绑定-Model-View" class="headerlink" title="2. 双向绑定: Model  View"></a>2. 双向绑定: Model <-> View</-></h3><ul>
<li>通过绑定<code>&lt;input&gt;</code>的 <code>onChange()</code> 监视 View的变换</li>
<li>在 onChange Handler中更新组件的值，完成 View =&gt; Model 的数据流。</li>
</ul>
<h3 id="3-React-生命周期"><a href="#3-React-生命周期" class="headerlink" title="3. React 生命周期"></a>3. React 生命周期</h3><ul>
<li><strong>Mount</strong><ul>
<li>constructor()</li>
<li>componentWillMount()</li>
<li>render()</li>
<li>componentDidMount()</li>
</ul>
</li>
<li><strong>Update</strong><ul>
<li>componentWillReceiveProps(): 将接收新的props</li>
<li>shouldComponentUpdate(): 是否应该被更新？</li>
<li>componentWillUpdate(): 组件即将更新</li>
<li>render(): 组件被渲染</li>
<li>componentDidUpdate(): 组件完成更新</li>
</ul>
</li>
<li><strong>Unmount</strong><ul>
<li>componentWillUnmount(): 组件被卸载前做一些数据清除</li>
</ul>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-categories" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/18/VM-Page-Table-Page-Fault-Hander/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mingkai Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sea.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMK">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/18/VM-Page-Table-Page-Fault-Hander/" itemprop="url">VM: Page Table & Page Fault Hander</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-18T15:22:02-07:00">2018-04-18</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Courses/" itemprop="url" rel="index"><span itemprop="name">Courses</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/18/VM-Page-Table-Page-Fault-Hander/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments:</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/04/18/VM-Page-Table-Page-Fault-Hander/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="I-Page-Table"><a href="#I-Page-Table" class="headerlink" title="I. Page Table"></a>I. Page Table</h2><h4 id="1-Page-table的作用"><a href="#1-Page-table的作用" class="headerlink" title="1. Page table的作用"></a>1. Page table的作用</h4><p><strong>【简洁版】</strong></p>
<ul>
<li>隔离user process，给每个process分配4GB内存【假象，至于到底怎么分配，交给kernel】</li>
<li>提供 CPU 可识别的 physical address</li>
</ul>
<p><strong>【详细版】</strong></p>
<ul>
<li>在没有 page table 之前，processes 如果想在memory中执行，必须做好process isolation。一个方案是为每个process 分配一段“大小合适的”内存，这样的缺点是：<ul>
<li>首先，分配的内存必须连续；否则还需要 page table</li>
<li>其次，多大才算“大小合适”，因为process在加载之前无法预知它会使用多少内存</li>
</ul>
</li>
<li>另一种方案是：将内存划分成很小的“页”，按需使用；这样解决了“大小合适”的问题，但仍然存在内存必须连续的问题（否则会引起内存侵扰）</li>
<li>最后的方案是：page table。建立虚拟内存，对于32bit机器而言：<ul>
<li>给每个process的内存都是4GB[0x00000000~0xffffffff]</li>
<li>同时kernel在每个processz的PCB中都维护一个 page table<br>提供给 CPU 可操作的 physical address</li>
<li>一般情况下不知直接采用一级 page table，即将所有 4GB 的vaddr映射到 4GB的physical addr，占空间太大了！！<strong>【page table在memory中， kernel 1GB的address space中】</strong></li>
</ul>
</li>
</ul>
<h4 id="2-代码分析-Weenix"><a href="#2-代码分析-Weenix" class="headerlink" title="2. 代码分析 - Weenix"></a>2. 代码分析 - Weenix</h4><p>Weenix 中 page table 实际上由 pagedir struct (pagetable.c)负责维护，结构如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pagedir</span> &#123;</span></span><br><span class="line">        <span class="keyword">pde_t</span>      pd_physical[PT_ENTRY_COUNT];</span><br><span class="line">        <span class="keyword">uintptr_t</span> *pd_virtual[PT_ENTRY_COUNT];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pt_map</span><span class="params">(<span class="keyword">pagedir_t</span> *pd, <span class="keyword">uintptr_t</span> vaddr, <span class="keyword">uintptr_t</span>   </span></span></span><br><span class="line"><span class="function"><span class="params">           paddr, <span class="keyword">uint32_t</span> pdflags, <span class="keyword">uint32_t</span> ptflags)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">将指定的 virtual addr 与 physical addr</span><br></pre></td></tr></table></figure>
<ol>
<li>每一个 vaddr 都由唯一对应两个表的index： pagedir table index、page table index<ul>
<li>pagedir index = (vaddr&gt;&gt;12) / PAGE_ENTRY_CNT</li>
<li>pagetable index = (vaddr&gt;&gt;12) % PAGE_ENTRY_CNT</li>
<li>注意：pagedir table中存的是 [index1: pagetable physical addre]的entry</li>
<li>注意：page table中存的才是[index2:physical addr]的entry</li>
<li>这样就建立起 vaddr 的 Two-Level translation system；<br>先通过 pagedir table 找到 page table，在查到对应 physical addr</li>
</ul>
</li>
<li>pagedir： <ul>
<li>由 PCB 维护一个指针指向该 page directory table</li>
<li>从pagedir开始，逐级查找到该 process的address space对应的physical address</li>
</ul>
</li>
<li>pd_physical[i]： <ul>
<li>由 (vaddr&gt;&gt;12) / PAGE_ENTRY_CNT 计算出vaddr所对应的 pagedir table中的entry</li>
<li>该 entry 中维护一个指针指向下级 page table的 physical address；即vaddr所在的page table</li>
</ul>
</li>
<li>*pd_virtual[i]：<ul>
<li>由(vaddr&gt;&gt;12) % PAGE_ENTRY_CNT计算出vaddr对应的 page table 中的entry</li>
<li>该 entry 维护中vaddr 对应的 physical addr</li>
</ul>
</li>
</ol>
<p><br></p>
<h2 id="II-Page-fault"><a href="#II-Page-fault" class="headerlink" title="II. Page fault"></a>II. Page fault</h2><h4 id="1-page-fault-handler-具体步骤"><a href="#1-page-fault-handler-具体步骤" class="headerlink" title="1. page fault handler 具体步骤"></a>1. page fault handler 具体步骤</h4><p>page fault 是由MMU检测到的硬件中断，由kernel处理；当一个进程发生缺页中断的时候，进程会<strong>陷入(trap)内核态</strong>，执行以下操作： </p>
<ol>
<li>检查要访问的虚拟地址是否合法 </li>
<li>查找/分配一个物理页 </li>
<li>填充物理页内容（读取磁盘，或者直接置0，或者啥也不干） </li>
<li>建立映射关系（虚拟地址到物理地址） </li>
<li>重新执行发生缺页中断的那条指令 </li>
</ol>
<h4 id="2-代码分析-page-fault-handler"><a href="#2-代码分析-page-fault-handler" class="headerlink" title="2. 代码分析 - page fault handler"></a>2. 代码分析 - page fault handler</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_pagefault</span><span class="params">(<span class="keyword">uintptr_t</span> vaddr, <span class="keyword">uint32_t</span> cause)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">输入：vaddr【导致发生缺页中断的 vaddr】 </span><br><span class="line">     cause【page fault的原因】</span><br><span class="line">        + write on RDONLY</span><br><span class="line">        + write on Reserved, etc.</span><br><span class="line">输出：<span class="keyword">void</span></span><br></pre></td></tr></table></figure>
<ol>
<li>检查该 vaddr 真的是cur_proc 地址空间中的使用的 addr 么?<ul>
<li><code>vmarea = vmmap_lookup(curproc-&gt;p_vmmap, ADDR_TO_PN(vaddr))</code></li>
<li>if == NULL，表明地址空间中就没有 任何一个 region用到该地址，返回Error</li>
</ul>
</li>
<li>至此，获得了该 vaddr 所属的 vmarea；<ul>
<li>获得vmarea的目的，是为了获得该vaddr实际对应的mmobj</li>
<li>只有通过<code>vmmap_lookup()</code><strong>找出“幕后主使”</strong>，才能够进行后续往物理内存中加载内容</li>
<li>比如只有找出该vaddr对应的vmarea，继而找到vnode(即对应的file)，才能知道该往内存中读入什么！！</li>
<li>user process 程序操作的全是vaddr，不知道该vaddr实际对应的是什么；但是查询到该vaddr page 所属的 mmobj就知道该往物理内存中读入什么了</li>
</ul>
</li>
<li>注意特殊情况：forwrite，这会引起有意思的 Copy_On_Write</li>
<li>重要的一步：往physical page加载mmobj，并更新page table with (vaddr：paddr)<ul>
<li>通过调用 <code>pframe_lookup(vmarea, pageNum, fw, *pframe)</code>,找该vmarea下的pframe</li>
<li>实际上vmarea不直接管理pframe，而是vmarea对应的mmobj管理；继而内部调用 vmarea—&gt;mmobj 的 <code>lookuppage()</code></li>
<li>mmobj 调用<code>pframe_get()</code>寻找是否有相应的 pframe 对应于 mmonj&amp;pageNum</li>
<li>如果有：直接返回；</li>
<li>如果没有：进入<em>“无中生有”</em>这一步：<ul>
<li>创建 pframe 结构体，获得physical address。 通过：<code>pframe_alloc(mmobj,pagenum)</code>  <ol>
<li><strong>这一步会调用 <code>page_alloc()</code> 申请到物理内存physical address</strong>  </li>
<li>至此vaddr有了与之对应的物理内存，但还未载入vaddr对应的内容</li>
</ol>
</li>
<li>调用 <code>pframe_fill()</code>往刚申请到的physical addr中载入vaddr对应的内容  <ol>
<li><strong>这一步调用 <code>mmobj-&gt;ops-&gt;fillpage(obj,pf)</code>由vaddr对应的mmobj向物理内存载入内容</strong>  </li>
<li>实际上如果是disk，会调用<code>read_block()</code>进入硬件过程；后续还会通过DMA(direct memory access)直接将disk中的内容读入到内存</li>
</ol>
</li>
<li>至此，mmobj的<strong>幕后人物：vnode / file</strong> 的内容成功读入到 page frame 中</li>
</ul>
</li>
</ul>
</li>
<li>最后调用 <code>pt_map(curproc-&gt;pdir, vaddr, pt_virt_to_phys(pf_addr),...)</code>将 (vadd:paddr)写到 page table 中</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">【实质】</span><br><span class="line"></span><br><span class="line"> virtualAddr &lt;=&gt; pframe &lt;=&gt; physicalAddr</span><br><span class="line">      |            |             |</span><br><span class="line">     user        kernel     physical mem</span><br><span class="line">      |            |             |</span><br><span class="line">      3G    1G=2^20*2^12=4K &lt;==&gt; 4G</span><br><span class="line">       \_ _ _ _ _ _ _ _ _ _ _ _ _／</span><br><span class="line">       </span><br><span class="line">+ 任何一块物理内存都由一个对应的pframe指向,并管理；</span><br><span class="line">+ pframe本身为virtual address；甚至其内部与phsical page</span><br><span class="line">  直接关联的 pf_addr也是 virtual address。But why?**  </span><br><span class="line">+ 实际上:</span><br><span class="line">    - 1page = 4KB = 2^12 Byte</span><br><span class="line">    - physical mem(32bit): 4GB=2^32 Byte</span><br><span class="line">    - pframe #: 2^32 / 2^12 = 2^20 </span><br><span class="line">    - kernel address space: 1GB = 2^20</span><br><span class="line">    - 也就是说：使用pframe分配物理内存的话，</span><br><span class="line">              kernel pframes正好与physical pages形成对应</span><br><span class="line">    - 因此：在pframe创建之时(即对应物理内存征用之时)，</span><br><span class="line">      只需要做一个简单的加减法就可以！</span><br><span class="line">      因为 kernel 1G [c0000000~ffffffff],对应4GB；</span><br><span class="line">      那么减去的 delta=c0000000（该值需要再调整）</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-categories" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/18/VM-How-does-fork-work/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mingkai Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sea.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMK">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/18/VM-How-does-fork-work/" itemprop="url">VM: How does fork() work?</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-18T15:12:11-07:00">2018-04-18</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Courses/" itemprop="url" rel="index"><span itemprop="name">Courses</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/18/VM-How-does-fork-work/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments:</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/04/18/VM-How-does-fork-work/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="fork-in-Kernel"><a href="#fork-in-Kernel" class="headerlink" title="fork( ) in Kernel"></a><em>fork</em>( ) in Kernel</h2><p>跟<code>read()</code>一样: 都是user process调用kernel syscall，trap into kernel，在interrupt handler中指明interrupt routine，最终由kernel代为执行任务；</p>
<p>具体在kernle中要做的工作有以下几步：</p>
<ol>
<li>创建新的 PCB,<code>newProc = proc_create()</code></li>
<li>拷贝address space,<code>vmmap_copy(newProc)</code><ul>
<li>拷贝 vmmap(address space)的vmarea(只初步copy memory area):<br><code>newProc-&gt;p_vmmap = vmmap_clone(curproc-&gt;p_vmmap);</code></li>
<li>拷贝每个vmarea对应的mmobj, from curproc<ul>
<li>两个process的vmarea是一一对应的，遍历copy</li>
<li>首先获得即将要拷贝的curproc的第一个vmarea</li>
<li>从newProc的第一个vmarea开始，执行copy：<br> <code>curproc-&gt;vmarea-&gt;vma_obj</code></li>
<li>更新vma_obj的refcount</li>
<li>判断要该vmarea是否为Private,执行<strong>shadow copy</strong><ol>
<li>if private，执行shadow copy</li>
<li>并且要新vmarea插入到bottom_mmobj-&gt;mmo_vmas之后</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li>清除 curproc 的pageTable 以及TLB缓存(必须在thread copy之前)<ul>
<li>因为curproc的pageTable也会被copy(在thread copy的时候)<br>若不重新映射pageTable的话，两个process的vaddr会映射同一paddr</li>
<li>既然pageTable需要重新映射，那么TLB也需要重新缓存新映射</li>
</ul>
</li>
<li>创建新thread，拷贝cur thread内容，包括 register、stack、pageTable<ul>
<li>拷贝parent的TCB到新的TCB：kth_new,<code>kth_new = kthread_clone(curthr)</code></li>
<li>设置所属process，<code>kth_new-&gt;kt_proc = newProc</code></li>
<li>将新thread插入到process的“线程链”之后</li>
<li>更新register信息（包括page table信息）<ul>
<li><strong>其实pageTable是给CPU使用的(以下可看出)</strong></li>
<li><code>kt_ctx.c_pdptr = newProc-&gt;p_pagedir</code></li>
<li><code>kt_ctx.c_eip = (uint32_t)userland_entry</code></li>
<li><code>kt_ctx.c_esp = fork_setup_stack(regs,kth_new-&gt;kt_kstack)</code></li>
<li><code>kt_ctx.c_kstack = (uintptr_t) kth_new-&gt;kt_kstack</code></li>
<li><code>kt_ctx.c_kstacksz = DEFAULT_STACK_SIZE</code></li>
</ul>
</li>
</ul>
</li>
<li>拷贝file system的内容<ul>
<li>拷贝curProc的file-descriptor-table</li>
<li>注意这里是拷贝的 fd table的内容，并非 open-connection-table</li>
<li>因为fd-table很大：NFILES，遍历拷贝<ul>
<li>如果 p-&gt;p_files[i] != NULL，表明对应实际open-file</li>
<li>还需要更新该open-file的refcount</li>
</ul>
</li>
</ul>
</li>
<li>拷贝p_cwd，并更新p_cwd的refcount:<code>p-&gt;p_cwd = curproc-&gt;p_cwd;</code><ul>
<li>注意：这里的<code>p_cwd</code>在<code>proc_creat()</code>的时候复制了一遍了</li>
<li>同时也要考虑<code>p_cwd=NULL</code>的情况如何处理</li>
</ul>
</li>
<li>设置 heap segment 的break，与 curproc 的一致</li>
<li>将新thread加入到 run queue 中</li>
<li>设置 parent proc的fork()返回值：newProc-&gt;p_pid</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-categories" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/18/VM-Virtual-memory-File-system-Memory-object-in-VM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mingkai Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sea.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMK">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/18/VM-Virtual-memory-File-system-Memory-object-in-VM/" itemprop="url">VM: Virtual memory + File system = Memory object(in VM)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-18T15:07:05-07:00">2018-04-18</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Courses/" itemprop="url" rel="index"><span itemprop="name">Courses</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/18/VM-Virtual-memory-File-system-Memory-object-in-VM/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments:</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/04/18/VM-Virtual-memory-File-system-Memory-object-in-VM/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="I-Virtual-memory-amp-File-system"><a href="#I-Virtual-memory-amp-File-system" class="headerlink" title="I. Virtual memory &amp; File system"></a>I. Virtual memory &amp; File system</h2><h4 id="1-file可以直接映射进memory，更快，但无cache。"><a href="#1-file可以直接映射进memory，更快，但无cache。" class="headerlink" title="1. file可以直接映射进memory，更快，但无cache。"></a>1. file可以直接映射进memory，更快，但无cache。</h4><h4 id="2-从disk读取文件有两种方法：read-and-mmap"><a href="#2-从disk读取文件有两种方法：read-and-mmap" class="headerlink" title="2. 从disk读取文件有两种方法：read() and mmap()"></a>2. 从disk读取文件有两种方法：<code>read()</code> and <code>mmap()</code></h4><ul>
<li>read(): <ul>
<li>user process： 系统调用<code>read()</code>，trap into kernel</li>
<li>kernel： 执行interrupt handler，调用do_read()；继而调用 file system的 read() 指令</li>
<li>kernel space：读入的内容放到 kernel address space</li>
<li>user space： kernel 将内容copy到 user address space</li>
</ul>
</li>
<li>mmap(): <ul>
<li>user process：系统调用<code>mmap()</code>，trap into kernel</li>
<li>kernel ：执行interrupt handler，调用 do_mmap()；继而调用 file system 的 mmap() 指令</li>
<li>user space： kernel 直接将 file 映射到 user address space中</li>
</ul>
</li>
</ul>
<h4 id="3-file-system-中的-vnode-结构体："><a href="#3-file-system-中的-vnode-结构体：" class="headerlink" title="3. file system 中的 vnode 结构体："></a>3. file system 中的 vnode 结构体：</h4><pre><code>- 对应一个电脑文件系统中的一个 file
- 其中还有一个 mmobj vn_mmobj 结构体： 是该file到address space 中的映射。 mmobj 包含：
    + mmo_operations
        - lookuppage：根据[mmobj:page#], 找对应的 pframe
        - fillpage：将 disk file 内容加载到 pframe
        - dirtypage：将该 mmobj 指定的 pframe 设置为 dirty
        - cleanpage：将该 mmobj指定的 pframe 清楚
        - ref
        - put
    + mmo_refcount
    + mmo_resident_pages
- vnode 为抽象的 inode，来实现 polymophism。也有与file 相关的 operations：
    + read
    + write
    + mmap(): 注意这个mmap 是vnode层面的function；**实际上返回的是 vnode-&gt;vn\_mmobj; 而这个vn\_mmobj则是通过上述的fillpage()实际将 disk 中的数据加载进 pframe**
</code></pre><h2 id="II-vmmap-c"><a href="#II-vmmap-c" class="headerlink" title="II. vmmap.c"></a>II. vmmap.c</h2><h4 id="1-vmmap-lookup"><a href="#1-vmmap-lookup" class="headerlink" title="1. vmmap_lookup"></a>1. vmmap_lookup</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vmarea_t</span> * vmmap_lookup(<span class="keyword">vmmap_t</span> *<span class="built_in">map</span>, <span class="keyword">uint32_t</span> vfn)</span><br><span class="line"></span><br><span class="line"><span class="function">Find the vm_area that <span class="title">vfn</span><span class="params">(<span class="keyword">virtual</span> frame number)</span> lies in</span></span><br></pre></td></tr></table></figure>
<h4 id="2-vmmap-map"><a href="#2-vmmap-map" class="headerlink" title="2. vmmap_map"></a>2. vmmap_map</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vmmap_map(<span class="keyword">vmmap_t</span> *<span class="built_in">map</span>, <span class="keyword">vnode_t</span> *file, </span><br><span class="line">          <span class="keyword">uint32_t</span> lopage, <span class="keyword">uint32_t</span> npages, </span><br><span class="line">          <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">off_t</span> off, </span><br><span class="line">          <span class="keyword">int</span> dir, <span class="keyword">vmarea_t</span> **<span class="keyword">new</span>)</span><br><span class="line">- <span class="built_in">map</span> 为cur process 的地址空间</span><br><span class="line">- file 为被映射到虚拟内存的 vnode/shadow/anonymous obj</span><br><span class="line">- lopage、npages 指明从地址空间的什么具体位置开始映射、映射长度</span><br><span class="line">- prot、flag、off 指明 vmarea 的 read/write、<span class="keyword">public</span>/<span class="keyword">private</span>、 vmarea的起始地址</span><br><span class="line">- <span class="keyword">new</span> 为接收 映射file到虚拟内存的 mapped\_file\_obj 的指针</span><br><span class="line"></span><br><span class="line">【注意】该函数被 system API:do_mmap()调用；完成</span><br></pre></td></tr></table></figure>
<p>将指定的 file(anonymous／shadow) 映射map到该进程的“地址空间”address space中；经历一下步骤：</p>
<ol>
<li><p>现在cur_proc的地址空间中开辟一块 vmarea </p>
<ul>
<li>if lopage=0: 开辟一个新的 vmarea</li>
<li>if lopage!=0: 如果该位置已经被别的vmarea占用，那么删除就的vmarea</li>
</ul>
</li>
<li><p>对刚获得的 vmarea 赋值：</p>
<ul>
<li>newvma-&gt;vma_start = lopage;</li>
<li>newvma-&gt;vma_end = lopage + npages;</li>
<li>newvma-&gt;vma_off = ADDR_TO_PN(off);</li>
<li>newvma-&gt;vma_prot = prot;</li>
<li>newvma-&gt;vma_flags = flags;</li>
<li>list_link_init(&amp;newvma-&gt;vma_plink);</li>
<li>list_link_init(&amp;newvma-&gt;vma_olink);</li>
</ul>
</li>
<li><p>创建 mmobj（<strong>这是 vmarea 存在的意义</strong>）</p>
<ul>
<li>if file==NULL: mmobj为新创建的 anonymous obj;<br><code>mmobj = anon_create();</code></li>
<li>if file!=NULL: mmobj为从vnode读入的 mmobj;<br><code>file-&gt;vn_ops-&gt;mmap(file, newvma, &amp;mmobj);</code></li>
<li>判断是否需要创建 shadow obj<br><code>if MAP_PRIVATE &amp; flags != 0</code> 需要在 mmobj内部创建 shadow obj</li>
</ul>
</li>
<li><p>将mmobj 链接到 vmarea上；<code>newvma-&gt;vma_obj = mmobj;</code></p>
</li>
<li><p>将vmarea 插入到 cur_proc 的 地址空间 map 中</p>
</li>
</ol>
<h4 id="3-vmmap-remove"><a href="#3-vmmap-remove" class="headerlink" title="3. vmmap_remove()"></a>3. vmmap_remove()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vmmap_remove</span><span class="params">(<span class="keyword">vmmap_t</span> *<span class="built_in">map</span>, <span class="keyword">uint32_t</span> lopage, <span class="keyword">uint32_t</span> npages)</span></span></span><br></pre></td></tr></table></figure>
<ol>
<li>删除虚拟内存/virtual address 中的对应的 mmobj</li>
<li>并删除相应 page table entry，相当于释放物理内存</li>
</ol>
<h4 id="4-vmmap-is-range-empty"><a href="#4-vmmap-is-range-empty" class="headerlink" title="4. vmmap_is_range_empty"></a>4. vmmap_is_range_empty</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vmmap_is_range_empty</span><span class="params">(<span class="keyword">vmmap_t</span> *<span class="built_in">map</span>, <span class="keyword">uint32_t</span> startvfn, <span class="keyword">uint32_t</span> npages)</span></span></span><br></pre></td></tr></table></figure>
<p>判断指定的一段pages 在否在虚拟内存中未被占用</p>
<h4 id="5-vmmap-read"><a href="#5-vmmap-read" class="headerlink" title="5. vmmap_read"></a>5. vmmap_read</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vmmap_read</span><span class="params">(<span class="keyword">vmmap_t</span> *<span class="built_in">map</span>, <span class="keyword">const</span> <span class="keyword">void</span> *vaddr, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span></span></span><br></pre></td></tr></table></figure>
<p>从 cur_proc 当前地址空间map中指定的vaddr开始，读取“内存”中大小为count的内容到指定的 “内存”buf 中（<strong>因为这里的“内存”是虚拟内存，必须要借助pframe_lookup()读取physical memory的值</strong>）</p>
<ol>
<li>循环执行以下步骤，直到读取字节数 达到count 数量；<ul>
<li>注意：因为count 是字节数，而 address space 中以 page 为单位；并且page之间并非一直连续，是由 vmarea 链接而成；因此需要遍历 地址空间逐个vmarea、逐个page 读取</li>
</ul>
</li>
<li>在 address space 中查找 start vaddr所属的 vmarea</li>
<li>获得该 vmarea 中所包含的 pages</li>
<li>循环读取所有 pages，memcpy到指定buf<ul>
<li>调用<code>pframe_lookup()</code> 找到 virtual page 的 physical page </li>
<li>注意1：如果之前并没有 mapped physical address；那么会调用<code>pframe_get()</code> 即刻map一个physical address</li>
<li>注意2: 这里的 physical address 并非真正的，而依然是存在kernel address space 的 virtual address</li>
<li>调用 <code>memcpy()</code>将对应的pframe中的内容copy到指定的buf中去</li>
<li>注意3:因为<code>memcpy()</code>是C语言库函数，这里实际上还是“virtual address”之间的内容拷贝。很有可能在<code>memcpy()</code>实现了“virtual address to physical address”的转换</li>
</ul>
</li>
<li>直到该vmarea所有pages都copy完<ul>
<li>if count 未满足，则跳到下一个vmarea继续拷贝</li>
<li>if count 满足，则退出</li>
</ul>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-categories" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/14/Virtual-Memory-Allocation-brk-and-mmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mingkai Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sea.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMK">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/14/Virtual-Memory-Allocation-brk-and-mmap/" itemprop="url">VM - Virtual Memory Allocation: brk() and mmap() </a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-14T11:33:45-07:00">2018-04-14</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Courses/" itemprop="url" rel="index"><span itemprop="name">Courses</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/14/Virtual-Memory-Allocation-brk-and-mmap/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments:</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/04/14/Virtual-Memory-Allocation-brk-and-mmap/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Useful-Link"><a href="#Useful-Link" class="headerlink" title="Useful Link"></a>Useful Link</h2><p>Credit goes to:<br><a href="https://blog.csdn.net/gfgdsg/article/details/42709943" target="_blank" rel="noopener">https://blog.csdn.net/gfgdsg/article/details/42709943</a></p>
<h2 id="Notice-page-granularity"><a href="#Notice-page-granularity" class="headerlink" title="Notice: page-granularity"></a>Notice: page-granularity</h2><p>All memory in virtual memory address space are <strong>page-based</strong>. It is the smallest unit of granularity, including the Heap segment in the following.</p>
<h2 id="Virtual-Memory-Allocation-2-ways"><a href="#Virtual-Memory-Allocation-2-ways" class="headerlink" title="Virtual Memory Allocation (2 ways):"></a>Virtual Memory Allocation (2 ways):</h2><ol>
<li><code>brk()</code> on Heap segment</li>
<li><code>mmap()</code> mapped_file segment, between Heap and Stack</li>
</ol>
<p>Usually user process calls <code>malloc()</code> to invoke kernel<br>system calls <code>brk()</code> or <code>mmap()</code> to get a virtual memory. Which one will be executed depends on <strong>requesting memory size(128KB is the line)</strong></p>
<ul>
<li><em>size&lt;128KB</em>, kernel calls <code>brk()</code> to assign virtual memory on Heap to user process<ul>
<li><strong>BAD:</strong> only be sequentially assign and free, like Stack</li>
<li><strong>GOOD:</strong> can be used as cache ()</li>
</ul>
</li>
<li><em>size&gt;128KB</em>, kerel calls <code>mmap()</code> to get a piece of memory between Heap and Stack to user process<ul>
<li><strong>GOOD:</strong> can independently assign and free (flexible)</li>
<li><strong>BAD:</strong> repeately causing page_fault to involve physical memory (CPU costly)</li>
</ul>
</li>
</ul>
<h2 id="System-API：do-brk"><a href="#System-API：do-brk" class="headerlink" title="System API：do_brk( )"></a>System API：do_brk( )</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_brk</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">void</span> **ret)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">设置 process 地址空间中Heap Segment的break，即Heap的“堆顶”。  </span><br><span class="line">- <span class="built_in">malloc</span>()、<span class="built_in">free</span>()均会调用该API，增加、减小heap <span class="keyword">break</span></span><br><span class="line">- <span class="built_in">malloc</span>()时向高地址增加; <span class="built_in">free</span>()时向低地址减小</span><br><span class="line"></span><br><span class="line">输入： addr 要更新的<span class="keyword">break</span>地址； ret 更新后的<span class="keyword">break</span>地址</span><br><span class="line">输出：<span class="number">0</span>-成功</span><br></pre></td></tr></table></figure>
<ol>
<li>如果 addr == NULL，返回当前 brk</li>
<li>判断 addr 的合法性：与 proc_start_brk比较，不能比他还小</li>
<li>处理 addr 与 proc_brk 在 page_not_aligned 的情况；并获得old proc_brk所在 virtual area 的最后一页 end_page<ul>
<li>addr : newvfn (new virtual frame number)</li>
<li>curproc-&gt;p_brk: oldvma-&gt;vma_end</li>
<li>if(newvfn &gt; oldvma-&gt;vma_end): 对应于<code>malloc()</code></li>
<li>if(newvfn &lt; oldvma-&gt;vma_end): 对应于<code>free()</code></li>
</ul>
</li>
<li>最后更新两个量：<ul>
<li>oldvma-&gt;vma_end = newvfn;</li>
<li>curproc-&gt;p_brk = addr;</li>
</ul>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-categories" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/13/How-Does-Kernel-Handle-System-Calls/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mingkai Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sea.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMK">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/13/How-Does-Kernel-Handle-System-Calls/" itemprop="url">How Does Kernel Handle System Calls</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-13T11:52:25-07:00">2018-04-13</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Courses/" itemprop="url" rel="index"><span itemprop="name">Courses</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/13/How-Does-Kernel-Handle-System-Calls/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments:</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/04/13/How-Does-Kernel-Handle-System-Calls/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="I-An-Example-read"><a href="#I-An-Example-read" class="headerlink" title="I. An Example: read( )"></a>I. An Example: read( )</h2><ol>
<li><strong>User space:</strong> User process makes <code>read()</code> system call</li>
<li><strong>Interrupt:</strong> This will <strong>trap</strong> into kernel by <strong>software interrupt</strong></li>
<li><strong>System API:</strong> Kernel executes its <code>interrupt handler</code>, in which <code>sys_read() API</code> will be called<ul>
<li><code>copy_from_user()</code> the read_args(fd/buff/…)</li>
<li><code>page_alloc()</code> a temporary buffer</li>
<li>call <code>do_read()</code>, and <code>copy_to_user()</code> the read bytes</li>
<li><code>page_free()</code> that buffer</li>
<li>return the number of bytes actually read, or if anything goes wrong</li>
</ul>
</li>
<li><strong>File system API</strong>: Specific file system function <code>do_read()</code> will be executed.<ul>
<li>注意：<code>do_read()</code>是 file system 的 system call</li>
</ul>
</li>
</ol>
<h2 id="II-System-API-for-file-operation"><a href="#II-System-API-for-file-operation" class="headerlink" title="II. System API for file operation"></a>II. System API for file operation</h2><h4 id="1-System-Read-API"><a href="#1-System-Read-API" class="headerlink" title="1. System Read API"></a>1. System Read API</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_read</span><span class="params">(<span class="keyword">read_args_t</span> *arg)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">kernel “读”操作的API，自此由kernel执行一系列“读”相关的操作</span><br><span class="line"></span><br><span class="line">输入：arg，包含了user process read()的所有参数</span><br><span class="line">输出：实际读出的字节数</span><br></pre></td></tr></table></figure>
<ol>
<li>作为 interrupt routine 被调用；发生于 user process <code>read()</code> leading to <em>trap as software interrupt</em> into kernel 的时候</li>
<li><code>copy_from_user()</code> 读取 user process <code>read()</code>的传入参数</li>
<li>在 kernel address space 分配一块buffer，作为临时接收数据的区域</li>
<li>调用 file system 的 <code>do_read()</code>，从 disk 中 读取数据到 buffer</li>
<li><code>copy_to_user()</code>,将buffer 中读取到的数据 copy 到 user address space（低地址空间 0xc0000000 - 0xc0000000）</li>
<li><code>page_free()</code>,将 buffer 释放</li>
<li>根据 file system 读取的结果，返回ERROR 或者 读取的字节数</li>
</ol>
<h4 id="2-System-Write-API"><a href="#2-System-Write-API" class="headerlink" title="2. System Write API"></a>2. System Write API</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_write</span><span class="params">(<span class="keyword">write_args_t</span> *arg)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">kernel “写”操作的API，自此由kernel执行一系列“写”相关的操作</span><br><span class="line"></span><br><span class="line">输入：arg，包含了user process write()的所有参数</span><br><span class="line">输出：实际写入的字节数</span><br></pre></td></tr></table></figure>
<ol>
<li>在kernel address space 开辟临时buffer，读取放置user 要写的数据</li>
<li>从 user address space 拷贝 <code>read()</code> 输入参数，包括要写的数据</li>
<li>调用 file system 的<code>do_write()</code>操作， write to disk</li>
<li>释放 kernel address space 的临时 buffer</li>
<li>返回ERROR 或者 写入的字符数</li>
</ol>
<h4 id="3-System-Get-Directory-Entry"><a href="#3-System-Get-Directory-Entry" class="headerlink" title="3. System Get Directory Entry"></a>3. System Get Directory Entry</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_getdent</span><span class="params">(<span class="keyword">int</span> fd, struct dirent *dirp)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">对目录文件的操作，比如：</span><br><span class="line">- 获得位于指定字节数位置的子目录entry</span><br><span class="line">- 显示某个文件夹下所有子目录名称、大小等信息</span><br><span class="line"></span><br><span class="line">输入：fd(要读取的文件指针)、dirp(目标dir entry的容器)</span><br><span class="line">输出：count_bytes</span><br></pre></td></tr></table></figure>
<ol>
<li><code>copy_from_user()</code>从 user address space 读取参数到 kernel address space（从而知道用户都想干些啥？） </li>
<li>循环调用 <code>do_getdent()</code> 以及 <code>copy_to_user()</code>，直到达到user process 指定的 字节数目<ul>
<li><code>do_getdent()</code> 调用 file system API 读取目录，并将结果放在 dir 中</li>
<li><code>copy_to_user()</code>将 dir 中的信息 copy 到 user address space 中去；这样就会在用户的 fd 下逐渐显示出读入的 sub dir entry 的名字、大小等信息</li>
<li>读入的 count_bytes &gt;= user_args.count 时，跳出循环</li>
</ul>
</li>
<li>返回实际读取到的目录所占字节数 count_bytes</li>
</ol>
<h4 id="4-Other-System-APIs-related-to-File-System"><a href="#4-Other-System-APIs-related-to-File-System" class="headerlink" title="4. Other System APIs related to File System"></a>4. Other System APIs related to File System</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_close</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_dup</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_dup2</span><span class="params">(<span class="keyword">const</span> <span class="keyword">dup2_args_t</span> *arg)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_mkdir</span><span class="params">(<span class="keyword">mkdir_args_t</span> *arg)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_rmdir</span><span class="params">(<span class="keyword">argstr_t</span> *arg)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_unlink</span><span class="params">(<span class="keyword">argstr_t</span> *arg)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_link</span><span class="params">(<span class="keyword">link_args_t</span> *arg)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_rename</span><span class="params">(<span class="keyword">rename_args_t</span> *arg)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_chdir</span><span class="params">(<span class="keyword">argstr_t</span> *arg)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_lseek</span><span class="params">(<span class="keyword">lseek_args_t</span> *args)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_open</span><span class="params">(<span class="keyword">open_args_t</span> *arg)</span></span></span><br></pre></td></tr></table></figure>
<p>以上的 system API 都与 file system 有关。都经过以下过程：</p>
<ol>
<li>User process makes system call: <code>read()</code></li>
<li>Traps into kernel as software interrupt: <code>interrupt handler</code></li>
<li>Kernel execute corresponding API: <code>sys_read()</code></li>
<li>Copy from user address space parameters into kernel address space</li>
<li>Ask File System to complete relavent operation: <code>do_read()</code></li>
<li>Copy to user address space with the result at kernel address space</li>
</ol>
<h2 id="III-Other-System-API-related-to-Virtual-Memory-System"><a href="#III-Other-System-API-related-to-Virtual-Memory-System" class="headerlink" title="III. Other System API related to Virtual Memory System"></a>III. Other System API related to Virtual Memory System</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_munmap</span><span class="params">(<span class="keyword">munmap_args_t</span> *args)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">sys_mmap</span><span class="params">(<span class="keyword">mmap_args_t</span> *arg)</span></span></span><br><span class="line"><span class="function">pid_t <span class="title">sys_waitpid</span><span class="params">(<span class="keyword">waitpid_args_t</span> *args)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">sys_brk</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_sync</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_stat</span><span class="params">(<span class="keyword">stat_args_t</span> *arg)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_fork</span><span class="params">(<span class="keyword">regs_t</span> *regs)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_execve</span><span class="params">(<span class="keyword">execve_args_t</span> *args, <span class="keyword">regs_t</span> *regs)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_kshell</span><span class="params">(<span class="keyword">int</span> ttyid)</span></span></span><br></pre></td></tr></table></figure>
<p>这些函数与“用户态” Process/ Thread/ Virtual Memory 的操作有关：</p>
<ol>
<li>由 user process 发起的 system call： <code>wait()</code></li>
<li>经过software interrupt trap into kernel</li>
<li>kernel 在调用相应的 system API，代替 user process 执行任务: <code>sys_waitpid()</code></li>
<li>交给“进程系统” Process&amp; Memory System，来具体处理任务：<code>do_waitpid()</code></li>
</ol>
<h2 id="VI-Interrupt-handler-for-syscalls"><a href="#VI-Interrupt-handler-for-syscalls" class="headerlink" title="VI. Interrupt handler for syscalls"></a>VI. Interrupt handler for syscalls</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">syscall_handler</span><span class="params">(<span class="keyword">regs_t</span> *regs)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">很重要的一个函数：</span><br><span class="line"><span class="number">1.</span> 使“用户态”程序在 make syscall 的时候，进入“内核态”</span><br><span class="line"><span class="number">2.</span> 根据 syscall_number，调用相应的 system API</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/sea.jpg"
                alt="Mingkai Cao" />
            
              <p class="site-author-name" itemprop="name">Mingkai Cao</p>
              <p class="site-description motion-element" itemprop="description">All-trade Jack, loves full-stack</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">49</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">65</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/caomingkai" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:mingkaic@usc.edu" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate"> 
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mingkai Cao</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.6</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="Total Visitors">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="Total Views">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.6"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.6"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.6"></script>



  



	





  





  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>

  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'hG8fgggWL7hK1jsXsRoVCNWv-MdYXbMMI',
        appKey: 'VRAYsgwdkRyyb8bAFQ5uii6o',
        placeholder: 'Any comment?',
        avatar:'',
        guest_info:guest,
        pageSize:'10' || 10,
    });
    // 新增以下代码即可，可以移除.info下所有子节点
    var infoEle = document.querySelector('#comments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0){
      infoEle.childNodes.forEach(function(item) {
        item.parentNode.removeChild(item);
      });
    }


  </script>



  





  

  

  

  

  
  

  

  

  

  


<style>
    #comments .vempty{
        display: none;
    }
</style>

</body>
</html>
